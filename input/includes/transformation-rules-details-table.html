{% assign transformation_rule = include['transformation-rule'] %}
{% assign mapping_filter = include.mapping %}
{% assign profile_filter_raw = include.profiles %}
{% assign heading_level = include.level | default: 4 %}

{% comment %}
	Filtering behavior:
	- If include.mapping is set and the rule has no mapping, render it ("applies to all").
	- If include.mapping is set and the rule has mapping, render only if it contains the filter.
		(Works for mapping as a string or as an array.)
	- If include.profiles is set, render only rules that reference one of the requested profile names
		(the comparison is case-insensitive and also matches Markdown links like [Profile](...)).
{% endcomment %}

{% assign rule_mapping = transformation_rule.mapping %}
{% assign profile_filter_list = nil %}

{% if profile_filter_raw %}
	{% assign profile_filter_json = profile_filter_raw | jsonify %}
	{% assign profile_filter_first = profile_filter_json | slice: 0, 1 %}
	{% if profile_filter_first == '[' %}
		{%- assign normalized_filters = profile_filter_json | replace: '["', '' | replace: '"]', '' -%}
		{%- assign normalized_filters = normalized_filters | replace: '","', '|__|' -%}
		{%- assign profile_filter_list = normalized_filters | split: '|__|' -%}
	{% else %}
		{%- assign normalized_filters = profile_filter_json | replace: '"', '' -%}
		{%- assign normalized_filters = normalized_filters | replace: '|', ',' -%}
		{%- assign profile_filter_list = normalized_filters | split: ',' -%}
	{% endif %}
{% endif %}

{% assign has_profile_filter = false %}
{% if profile_filter_list %}
	{% assign profile_filter_count = profile_filter_list | size %}
	{% if profile_filter_count > 0 %}
		{% assign has_profile_filter = true %}
	{% endif %}
{% endif %}

{% assign filter_out = false %}

{% if mapping_filter %}
	{% assign mapping_matches = false %}
	{% if rule_mapping %}
		{% assign mapping_json = rule_mapping | jsonify %}
		{% assign mapping_json_first = mapping_json | slice: 0, 1 %}
		{% if mapping_json_first == '[' %}
			{% assign normalized_mappings = mapping_json | replace: '["', '' | replace: '"]', '' %}
			{% assign normalized_mappings = normalized_mappings | replace: '","', '|__|' %}
			{% assign mapping_list = normalized_mappings | split: '|__|' %}
			{% for mapping_value in mapping_list %}
				{% assign mapping_value_normalized = mapping_value | strip | downcase %}
				{% if mapping_value_normalized == mapping_filter | downcase %}
					{% assign mapping_matches = true %}
				{% endif %}
			{% endfor %}
		{% else %}
			{% assign mapping_value_normalized = rule_mapping | strip | downcase %}
			{% if mapping_value_normalized == mapping_filter | downcase %}
				{% assign mapping_matches = true %}
			{% endif %}
		{% endif %}
	{% else %}
		{% assign mapping_matches = true %}
	{% endif %}

	{% unless mapping_matches %}
		{% assign filter_out = true %}
	{% endunless %}
{% endif %}

{% if filter_out != true and has_profile_filter %}
	{% assign matches_profile_filter = false %}
	{% if transformation_rule.profiles %}
		{% for rule_profile in transformation_rule.profiles %}
			{% assign profile_label = rule_profile | strip %}
			{% if profile_label contains '](' %}
				{% assign profile_label = profile_label | split: '](' | first %}
				{% assign profile_label = profile_label | remove: '[' %}
			{% endif %}
			{% assign profile_label_normalized = profile_label | strip | downcase %}
			{% for profile_filter in profile_filter_list %}
				{% assign filter_value = profile_filter | strip | downcase %}
				{% if filter_value != '' and profile_label_normalized == filter_value %}
					{% assign matches_profile_filter = true %}
				{% endif %}
			{% endfor %}
		{% endfor %}
	{% endif %}
	{% unless matches_profile_filter %}
		{% assign filter_out = true %}
	{% endunless %}
{% endif %}

{% unless filter_out %}

{% if transformation_rule.anchor %}
<a id="{{ transformation_rule.anchor }}"></a>
{% endif %}

<h{{ heading_level }}>{{ transformation_rule.title }}</h{{ heading_level }}>

<figure style="width: auto;">
	<table style="width: auto; border: 1px solid #dcdcdc;">
		{% if transformation_rule.id %}
			<tr>
				<th style="padding: 5px; width: 23rem;">ID</th>
				<td style="padding: 5px;"><code>{{ transformation_rule.id }}</code></td>
			</tr>
		{% endif %}
		<tr>
			<th style="padding: 5px; width: 23rem;">Beschreibung</th>
			{% assign description_html = transformation_rule.description | markdownify %}
			{% assign description_html = description_html | replace: '<pre>', '<pre style="overflow-x:auto; max-width: 100%; white-space: pre;">' %}
			{% assign description_html = description_html | replace: '<pre style="overflow-x:auto; max-width: 100%; white-space: pre;"><code>', '<pre style="overflow-x:auto; max-width: 100%; white-space: pre;"><code style="white-space: pre;">' %}
			{% assign description_html = description_html | replace: '<code class="', '<code style="white-space: pre;" class="' %}
			<td style="padding: 5px; overflow-x: auto;">{{ description_html }}</td>
		</tr>
		{% if transformation_rule.profiles %}
			<tr>
				<th style="padding: 5px; width: 23rem;">Profile</th>
				<td style="padding: 5px;">
					{% capture profiles_md %}
					{% for profile in transformation_rule.profiles %}
- {{ profile }}
					{% endfor %}
					{% endcapture %}
					{{ profiles_md | markdownify }}
				</td>
			</tr>
		{% endif %}
		{% if transformation_rule.references %}
			<tr>
				<th style="padding: 5px; width: 23rem;">Referenzen</th>
				<td style="padding: 5px;">
					{% capture refs_md %}
					{% for ref in transformation_rule.references %}
- {{ ref }}
					{% endfor %}
					{% endcapture %}
					{{ refs_md | markdownify }}
				</td>
			</tr>
		{% endif %}
	</table>
</figure>

{% endunless %}

