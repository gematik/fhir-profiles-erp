- id: F_006a
  anchor: f-006a
  title: "Organization für provide Dispensation"
  mapping: provide-dispensation
  profiles:
    - "[OrganizationDirectory](https://simplifier.net/vzd-fhir-directory/organizationdirectorystrict)"
  references:
    - "[A_25947 - E-Rezept-Fachdienst - ePA - provide-dispensation-erp - Organisation-Ressource](https://gemspec.gematik.de/docs/gemF/gemF_eRp_ePA/gemF_eRp_ePA_V1.2.1/#A_25947)"
  description: |
    Bei provide Dispensation ist die Organization neu zu erstellen, mit den Daten aus dem ACCESS_TOKEN. 

    Siehe A_25947 - E-Rezept-Fachdienst - ePA - provide-dispensation-erp - Organisation-Ressource

    Organization.identifier:TelematikID
      idNummer → aus dem ACCESS_TOKEN der Anfrage
    Organization.name 
      organizationName → aus dem ACCESS_TOKEN der Anfrage
    Organization.type:profession
      professionOID → aus dem ACCESS_TOKEN der Anfrage
- id: F_006b
  anchor: f-006b
  title: "Organization für provide Prescription"
  mapping: provide-prescription
  profiles:
    - "[OrganizationDirectory](https://simplifier.net/vzd-fhir-directory/organizationdirectorystrict)"
  references:
    - "[A_25946 - E-Rezept-Fachdienst - ePA - Mapping](https://gemspec.gematik.de/docs/gemF/gemF_eRp_ePA/gemF_eRp_ePA_V1.2.1/#A_25946)"
  description: |
    Bei provide Prescription ist die Organization aus der KBV_PR_FOR_Organization zu mappen.

    Der Transformator muss sicherstellen, dass bei Organization.identifier mindestens die TelematikID der Organisation enthalten, die auch im ACCESS_TOKEN der Anfrage angegeben ist. 
    Dazu muss nach der A_25946 die TelematikId bei "identifier:TelematikID" durch die idNummer aus dem ACCESS_TOKEN des verwendeten Operationsaufrufes ersetzt werden bzw. erzeugt werden, wenn diese nicht vorhanden ist.

    Folgende Operationen sind zusätzlich zum Mapping der StructureMaps durchzuführen:

    Organization.identifier:TelematikID
      idNummer → aus dem ACCESS_TOKEN der Anfrage
    
    Organization.name 
      organizationName → aus dem ACCESS_TOKEN der Anfrage
    
    Organization.type:profession
      professionOID → aus dem ACCESS_TOKEN der Anfrage
- id: F_007
  anchor: f-007
  title: "Address Slices in Organization"
  mapping: provide-prescription
  profiles:
    - "[KBV_PR_FOR_Organization](https://simplifier.net/for/kbv_pr_for_organization)"
    - "[OrganizationDirectory](https://simplifier.net/vzd-fhir-directory/organizationdirectorystrict)"
  references:
    - "[2024.05.28 - ePa Medikationsliste: Austausch IBM und PT Medical](https://wiki.gematik.de/display/ERPCHANGES/2024.05.28+-+ePa+Medikationsliste%3A+Austausch+IBM+und+PT+Medical)"
  description: |
    Beim Mapping der Organization bei providePrescription (siehe 006b) sollen die Extensions der Adresse:
    - Organization.address:Strassenanschrift.line.extension:Adresszusatz
    - Organization.address:Strassenanschrift.line.extension:Hausnummer
    - Organization.address:Strassenanschrift.line.extension:Strasse
    in das OpenSlicing des Organization-Profils des VZD übernommen werden, auch wenn diese nicht explizit dort modelliert sind.
- id: F_010
  anchor: f-010
  title: "Eintrag für MedicationRequest.subject"
  mapping: provide-prescription
  profiles:
    - "[KBV_PR_FOR_Patient](https://simplifier.net/for/kbv_pr_for_patient)"
    - "[EPA MedicationRequest](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-request.html)"
  references:
    - "[ANFERP-2638](https://service.gematik.de/browse/ANFERP-2638)"
  description: |
    Das Befüllen des MedicationRequest.subject muss erfolgen, indem die Werte von

    - Patient.identifier.system
    - Patient.identifier.value
    
    aus dem KbvBundle.patient.identifier übernommen werden und in der folgenden Form im ePA MedicationRequest angegeben werden:
    ```xml
      <subject>
        <identifier>
          <system value="http://fhir.de/sid/gkv/kvid-10" />
          <value value="X110411319" />
        </identifier>
      </subject>
    ```
- id: F_011
  anchor: f-011
  title: "Befüllung von Practitioner.name"
  mapping: provide-prescription
  profiles:
    - "[KBV_PR_FOR_Practitioner](https://simplifier.net/for/kbv_pr_for_practitioner)"
    - "[PractitionerDirectory](https://simplifier.net/vzd-fhir-directory/practitionerdirectorystrict)"
  references:
    - "[ANFERP-2639](https://service.gematik.de/browse/ANFERP-2639)"
  description: |
    Der Practitioner.name.text ist ein Pflichtfeld und muss aus den Namensinformationen erzeugt werden.

    Dabei ist folgende Bildungsregel anzuwenden:

    ```python
    def build_practitioner_name(practitioner):
      # Verknüpft Elemente einer Liste zu einem String, getrennt durch Leerzeichen
      def join_with_space(elements):
        return " ".join(elements)

      # Hilfsfunktion zum Abrufen des Werts einer Extension
      def get_extension_value(extensions, url):
        for ext in extensions:
          if ext.get("url") == url:
            return ext.get("valueString") or ext.get("valueCode", "")
        return ""

      # Namenszusätze und Präfix-Qualifier URLs
      namenszusatz_url = "http://hl7.org/fhir/StructureDefinition/humanname-namenszusatz"
      nachname_url = "http://hl7.org/fhir/StructureDefinition/humanname-own-name"
      vorsatzwort_url = "http://hl7.org/fhir/StructureDefinition/humanname-own-prefix"
      prefix_qualifier_url = "http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier"

      # Zusätzliche Namenskomponenten aus den Extensions abrufen
      family_extensions = practitioner["name"][0]["family"]["extension"]
      namenszusatz = get_extension_value(family_extensions, namenszusatz_url)
      nachname = get_extension_value(family_extensions, nachname_url)
      vorsatzwort = get_extension_value(family_extensions, vorsatzwort_url)
      prefix_extensions = practitioner["name"][0].get("prefix", [{}])[0].get("extension", [])
      prefix_qualifier = get_extension_value(prefix_extensions, prefix_qualifier_url)

      # Zusammensetzung des Namens
      prefix = join_with_space([practitioner["name"][0].get("prefix", {}).get("value", "")])
      given_name = practitioner["name"][0].get("given", "")
      family_name = f"{vorsatzwort} {nachname} {namenszusatz}".strip()

      # Zusammensetzen des vollständigen Namens mit Leerzeichen dazwischen
      full_name = f"{prefix_qualifier} {prefix} {given_name} {family_name}".strip()

      return full_name


    # Beispielhafte Verwendung
    practitioner_example = {
      "name": [
        {
          "use": "official",
          "family": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/StructureDefinition/humanname-namenszusatz",
                "valueString": "von",
              },
              {
                "url": "http://hl7.org/fhir/StructureDefinition/humanname-own-name",
                "valueString": "Müller",
              },
              {
                "url": "http://hl7.org/fhir/StructureDefinition/humanname-own-prefix",
                "valueString": "Dr.",
              },
            ],
            "family": "Müller",
          },
          "given": "Hans",
          "prefix": [
            {
              "extension": [
                {
                  "url": "http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier",
                  "valueCode": "AC",
                }
              ],
              "value": "Prof.",
            }
          ],
        }
      ]
    }

    print(build_practitioner_name(practitioner_example))
    ```
- id: F_013-01
  anchor: f-013-01
  title: "Befüllung der Telematik-ID des Arztes"
  mapping: provide-prescription
  profiles:
    - "[PractitionerDirectory](https://simplifier.net/vzd-fhir-directory/practitionerdirectorystrict)"
  references:
    - "[A_25946 - E-Rezept-Fachdienst - ePA Mapping](https://gemspec.gematik.de/docs/gemF/gemF_eRp_ePA/gemF_eRp_ePA_V1.2.1/#A_25946)"
  description: |
    Die Telematik-ID des Arztes wird wie folgt ermittelt und gesetzt:
    - Primär: Aus der QES-Signatur des Zertifikats.
    - Fallback: Wenn keine Telematik-ID in der QES-Signatur vorhanden ist, wird die Seriennummer des Zertifikats (Subject Serial Number) ausgelesen und die zugehörige Telematik-ID über die Nachschlagetabelle ermittelt.
    - Fehlerfall: Kann die Telematik-ID nicht ermittelt werden, wird die Verordnung nicht übertragen
- id: F_014
  anchor: f-014
  title: "Befüllung von MedicationDispense.subject.identifier"
  mapping: provide-dispensation
  profiles:
    - "[EPA MedicationDispense](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-dispense.html)"
  references:
    - "[ANFERP-2779](https://service.gematik.de/browse/ANFERP-2779)"
  description: |
    Beim Mapping von MedicationDispense.subject.identifier muss der Wert aus .value übernommen werden.
    Als system für jeden KVNR-Identifier eines Patienten "http://fhir.de/sid/gkv/kvid-10" gesetzt werden.
    
    Eine Unterscheidung nach GKV und PKV im System findet beim Mapping nicht mehr statt.
    Durch A_19248-03
    > "die KVNR des Versicherten im referenzierten Task (Task.for) gegen KVNR in MedicationDispense.subject:identifier (prüfen) und"
    kann man sich darauf verlassen, dass die KVNR im value gesetzt ist.
- id: F_015
  anchor: f-015
  title: "Mapping von Medication.code.coding"
  mapping: provide-dispensation
  profiles:
    - "[EPA Medication](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication.html)"
  references:
    - "[EML Testdaten - B714.1 eRp FD](https://wiki.gematik.de/display/B714ERPFD/EML+Testdaten)"
  description: |
    Beim Mapping von Medication.code.coding müssen alle Codings entfernt werden welche nicht explizit unter coding im EPA Medication Profil profiliert sind de.gematik.epa.medication | EPA Medication - SIMPLIFIER.NET auch wenn es sich bei Medication.code.coding um ein open Slizing handelt.

    Im E-Rezept-Fachdienst ist jetzt "hart" konfiguriert welche erlaubt sind. D.h. wenn im ePA Medication FHIR Profil neue hinzkommen, muss das explizit im eRP Fachdienst umgesetzt werden.
    <figure>
        <div class="gem-ig-img-container" style="--box-width: 700px; margin-bottom: 30px;">
            <img src="./medication-codings.png" alt="Erlaubte Medication Codings" style="width: 100%;">
        </div>
        <figcaption><strong>Abbildung: </strong>Erlaubte Medication Codings</figcaption>
    </figure>
- id: F_016
  anchor: f-016
  title: "Mapping des korrekten Practitioners"
  mapping: provide-prescription
  profiles:
    - "[KBV_PR_ERP_Bundle](https://simplifier.net/erezept/kbv_pr_erp_bundle)"
    - "[EPAOpProvidePrescriptionERPInputParameters](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-op-provide-prescription-erp-input-parameters.html)"
    - "[KBV_PR_FOR_Practitioner](https://simplifier.net/for/kbv_pr_for_practitioner)"
    - "[PractitionerDirectory](https://simplifier.net/vzd-fhir-directory/practitionerdirectorystrict)"
  references:
    - "[ANFERP-2780](https://service.gematik.de/browse/ANFERP-2780)"
  description: |
    Im https://simplifier.net/erezept/kbv_pr_erp_bundle sind zwei Practitioner erlaubt (AusstellendeVerschreibendeVerantwortlichePerson).
    Beim Mapping für provide-prescription muss der Practitioner übernommen werden, welcher in der Composition (https://simplifier.net/erezept/kbvprerpcomposition) unter “author” referenziert wird:

    ```xml
      <author> 
        <reference value="Practitioner/667ffd79-42a3-4002-b7ca-6b9098f20ccb"/> 
        <type value="Practitioner"/> 
      </author> 
      <attester> 
        <mode value="legal"/> 
        <party> 
          <reference value="Practitioner/d6f3b55d-3095-4655-96dc-da3bec21271c"/> 
        </party> 
      </attester>
    ```
- id: F_017
  anchor: f-017
  title: "Mapping von KBV_PR_ERP_Medication_Compounding"
  profiles:
    - "[EPA Medication](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication.html)"
    - "[EPA Medication Ingredient](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-pzn-ingredient.html)"
    - "[EPA Pharmaceutical Product Medication](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-pharmaceutical-product.html)"
  references:
    - "[ANFERP-2911](https://service.gematik.de/browse/ANFERP-2911)"
  description: |
    Handelt es sich bei der ingredient des QuellProfils um einen PZN Codierten Wirkstoff muss eine contained Medication vom Typ "EPA Medication Ingredient" hinzugefügt werden

    **Hinweis**: F_009 findet hier auch Anwendung

    Daher muss wenn Medication eine  KBV_PR_ERP_Medication_Compounding ist:

    Für jedes ingredient:

    1. Wenn ingredient.itemCodeableConcept.coding.system=`http://fhir.de/CodeSystem/ifa/pzn` dann weiter zu 2.
    2. Füge eine Medication (contained) hinzu vom Typ "EPA Medication Ingredient":

    ```xml
      <Medication>
          <id value="MedicationHydrocortison-FD" />
          <meta>
              <profile value="https://gematik.de/fhir/epa-medication/StructureDefinition/epa-medication-pzn-ingredient" />
          </meta>
          <!-- "EPA Medication Ingredients" haben haben immer diese Extension -->
          <extension url="https://gematik.de/fhir/epa-medication/StructureDefinition/epa-medication-type-extension">
              <valueCoding>
                  <system value="http://snomed.info/sct" />
                  <version value="http://snomed.info/sct/900000000000207008/version/20240201" />
                  <code value="781405001" />    
                  <display value="Medicinal product package (product)" />
              </valueCoding>
          </extension>
          <code>
              <coding>
                  <system value="http://fhir.de/CodeSystem/ifa/pzn" />
                  <code value="03424249" />                       <!-- Wert von ingredient.itemCodeableConcept.coding.code -->
                  <display value="Hydrocortison 1% Creme" />      <!-- Wert von ingredient.itemCodeableConcept.text -->
              </coding>
              <text value="Hydrocortison 1% Creme" />             <!-- Wert von ingredient.itemCodeableConcept.text -->
          </code>
      </Medication>
    ```

    3. In der Ziel Medication.ingredient setze die itemReference:

    ```xml
    <itemReference>
        <reference value="#MedicationHydrocortison-FD" />
    </itemReference>
    ```

    **Hinweise:**

    "EPA Medication Ingredients" haben haben immer die Extension:

    ```xml
      <extension url="https://gematik.de/fhir/epa-medication/StructureDefinition/epa-medication-type-extension">
        <valueCoding>
            <system value="http://snomed.info/sct" />
            <version value="http://snomed.info/sct/900000000000207008/version/20240201" />
            <code value="781405001" />    
            <display value="Medicinal product package (product)" />            
        </valueCoding>
      </extension>
    ```

    Die Werte in der EPA Medication Ingredients für `<code>` werden wie folgt gesetzt
    - code: Wert von ingredient.itemCodeableConcept.coding.code
    - display: Wert von ingredient.itemCodeableConcept.text
    - text: Wert von ingredient.itemCodeableConcept.text
- id: F_020
  anchor: f-020
  title: "Erzeugen von Medication.extension:type"
  profiles:
    - "[EPA Medication](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication.html)"
    - "[EPA Medication Ingredient](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-pzn-ingredient.html)"
    - "[EPA Pharmaceutical Product Medication](https://gemspec.gematik.de/ig/fhir/epa-medication/{{ site.data.constants.epa_med_service_version }}/StructureDefinition-epa-medication-pharmaceutical-product.html)"
  description: |
    Bei der Erzeugung von
      - EPA Medication
      - EPA Medication Ingredient
      - EPA Pharmaceutical Product Medication

    soll nach Möglichkeit `Medication.extension:type` erzeugt und mit dem korrekten Wert belegt werden.

    Folgende Optionen stehen für ePA 3.0 zur Verfügung (s. EPAMedicationTypeVS):

    | Code | Display | Deutsche Entsprechung |
    |---:|---|---|
    | 781405001 | Medicinal product package (product) | Fertigarzneimittel |
    | 1208954007 | Extemporaneous preparation (product) | Rezeptur |
    | 373873005 | Pharmaceutical / biologic product (product) | Komponente einer Kombipackung |

    Für folgende Konstellationen sind die Codes entsprechend zu setzen:

    | # | Konstellation | Quellprofil | Erkennung/Kriterium | EPA Medication (type) | EPA Medication Ingredient (type) | EPA Pharmaceutical Product Medication (type) |
    |---:|---|---|---|---|---|---|
    | 1 | PZN Verordnung | `KBV_PR_ERP_Medication_PZN` | `.form.code != KPG` | **Fertigarzneimittel** (`781405001`, *Medicinal product package (product)*) | n/a | n/a |
    | 2 | PZN Verordnung einer Kombipackung | `KBV_PR_ERP_Medication_PZN` | `.form.code = KPG` | Extension nicht setzen (wird über `.form.code` erkannt) | n/a | n/a |
    | 3 | Wirkstoffverordnung | `KBV_PR_ERP_Medication_Ingredient` | — | **Fertigarzneimittel** (`781405001`, *Medicinal product package (product)*) | n/a | n/a |
    | 4 | Freitextverordnung | `KBV_PR_ERP_Medication_FreeText` | — | Extension nicht setzen | n/a | n/a |
    | 5 | Rezeptur ohne PZNs in Rezepturbestandteilen | `KBV_PR_ERP_Medication_Compounding` | `.ingredient.itemCodeableConcept.text` | **Rezeptur** (`1208954007`, *Extemporaneous preparation (product)*) | n/a | n/a |
    | 6 | Rezeptur mit PZNs in Rezepturbestandteilen | `KBV_PR_ERP_Medication_Compounding` | `.ingredient.itemCodeableConcept.coding.code:pzn` | **Rezeptur** (`1208954007`, *Extemporaneous preparation (product)*) | **Fertigarzneimittel** (`781405001`, *Medicinal product package (product)*) | n/a |
